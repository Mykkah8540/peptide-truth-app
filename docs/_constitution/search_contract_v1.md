# Search Contract v1

## Purpose
Search must be deterministic, governed, and predictable. This document defines what search means in Pep-Talk and which inputs/outputs are allowed.

## Indexed entities
- Peptides (canonical content objects)
- Blends (canonical content objects)
- Topics (canonical content objects)
- Interactions (canonical content objects)
- Resources (canonical content objects)
- Stacks: **not** included in search unless explicitly added under a separate governed system

## Sources of truth
### Canonical content
- Canonical content JSON under `content/`

### Generated indices (build artifacts)
- `content/_index/` (generated)
- `content/peptides/_search_index.json` (generated)

No runtime “best guess” indexing is allowed in the app.

## Normalization rules
- Lowercase all tokens
- Trim whitespace
- Collapse repeated spaces
- Treat hyphen/underscore/space as equivalent separators
- Strip most punctuation except alphanumerics
- Greek letter spellings (alpha/beta/etc.) are handled via governed synonyms where needed
- Search is accent-insensitive only if supported by the tokenizer; otherwise synonyms must handle it

## Synonyms
- **Authoritative path:** `content/_taxonomy/search_synonyms_v1.json`
- Synonyms must be curated (no automatic expansions)
- Synonyms are applied at query time (not index time) unless explicitly documented
- Canonical name always wins ties

Notes:
- The app may include fallback reads for legacy paths, but they are not authoritative and must not be relied upon.

## Routing contract (deep links)
- **Authoritative generated routes index:** `content/_index/search_routes_v1.json`
- This file is generated by `scripts/index/build_search_routes_index.py`
- Route resolution must only route to known deep links defined in this index

## Search index contract
- **Authoritative peptide search index:** `content/peptides/_search_index.json`
- Schema version: `peptide_search_index_v1`
- This index is built by `scripts/index/build_search_index.py`

Blends:
- Blend search indexing is not yet implemented unless an explicit, governed blend index is added.

## Matching rules
- Primary: exact match on canonical slug or title tokens
- Secondary: token match on aliases/synonyms

Ranking (highest to lowest):
1) exact slug match
2) exact title match
3) token match on title
4) token match on aliases/synonyms
5) partial/fuzzy matches only if explicitly implemented and documented

## Output contract
Search returns:
- entity kind (`peptide|blend|topic|interaction|resource`)
- slug
- title
- optional short descriptor (safe, non-medical)

## Out of scope (locked)
- UGC is not searchable
- “Stack community” is not searchable
- Medical intent inference is not used for ranking
- No dosing/protocol suggestions in search behavior or output

## Governance
Any change to:
- indexed entity set
- normalization rules
- synonym rules
- routing behavior
- ranking behavior

Requires:
- updating this contract
- build-green proof
- a brief rationale in `docs/_status/current_state.md`
